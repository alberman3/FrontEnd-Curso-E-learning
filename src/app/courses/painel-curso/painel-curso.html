<div class="course-dashboard-wrapper">

  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Carregando curso...</p>
    </div>
  } @else {

    <!-- Header -->
    <header class="course-header">
      <button
        type="button"
        class="btn-back"
        (click)="goBack()"
        aria-label="Voltar para o painel de cursos">
        <mat-icon>arrow_back</mat-icon>
        <span>Voltar para cursos</span>
      </button>

      @if (course()) {
        <div class="course-title-header">
          <h1>{{ course()!.title }}</h1>
          <p>{{ course()!.description }}</p>
        </div>
      }
    </header>

    <div class="content-layout">

      <!-- Área principal: Vídeo/Conteúdo -->
      <main class="video-content-area">

        @if (!isEnrolled()) {
          <!-- Tela de Matrícula -->
          <mat-card class="enrollment-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>school</mat-icon>
                Faça sua matrícula
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p>Matricule-se neste curso para acessar todo o conteúdo e acompanhar seu progresso.</p>

              <div class="course-details">
                <div class="detail-item">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ course()?.workload }}h de conteúdo</span>
                </div>
                <div class="detail-item">
                  <mat-icon>menu_book</mat-icon>
                  <span>{{ modules().length }} módulos</span>
                </div>
                <div class="detail-item">
                  <mat-icon>play_circle</mat-icon>
                  <span>{{ getTotalLessons() }} aulas</span>
                </div>
              </div>

              @if (course()?.price && course()!.price > 0) {
                <div class="price-section">
                  @if (course()!.oldPrice > course()!.price) {
                    <span class="old-price">R$ {{ course()!.oldPrice }}</span>
                  }
                  <span class="price">R$ {{ course()!.price }}</span>
                </div>
              }
            </mat-card-content>
            <mat-card-actions>
              <button
                mat-raised-button
                color="primary"
                (click)="enroll()"
                [disabled]="!authService.isStudent()">
                <mat-icon>check_circle</mat-icon>
                Matricular-se Agora
              </button>

              @if (!authService.isStudent()) {
                <p class="warning-text">
                  <mat-icon>info</mat-icon>
                  Apenas alunos podem se matricular
                </p>
              }
            </mat-card-actions>
          </mat-card>

        } @else {
          <!-- Área do Player de Vídeo -->
          <div class="video-player-container">
            @if (currentLesson()) {
              @if (safeVideoUrl()) {
                <iframe
                  [src]="safeVideoUrl()"
                  [title]="'Vídeo da aula: ' + currentLesson()!.title"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
                </iframe>
              } @else {
                <div class="video-placeholder">
                  <mat-icon class="play-icon">play_circle</mat-icon>
                  <span class="video-msg">Esta aula não possui vídeo</span>
                </div>
              }
            } @else {
              <div class="video-placeholder">
                <mat-icon class="play-icon">play_circle</mat-icon>
                <span class="video-msg">Selecione uma aula para começar</span>
              </div>
            }
          </div>

          <!-- Conteúdo da Aula -->
          @if (currentLesson()) {
            <div class="lesson-content">
              <h2>{{ currentLesson()!.title }}</h2>
              <div class="lesson-text">
                {{ currentLesson()!.content }}
              </div>
            </div>
          }
        }

      </main>

      <!-- Sidebar: Módulos e Aulas -->
      <aside class="course-sidebar">

        <div class="sidebar-header">
          <h3>Conteúdo do Curso</h3>

          @if (isEnrolled()) {
            <div class="progress-section">
              <div class="progress-info">
                <span>Progresso: {{ progress() }}%</span>
                <mat-icon>emoji_events</mat-icon>
              </div>
              <mat-progress-bar
                mode="determinate"
                [value]="progress()">
              </mat-progress-bar>

              <!-- Botão de Certificado -->
              @if (canIssueCertificate()) {
                <button
                  mat-raised-button
                  color="accent"
                  class="certificate-button"
                  (click)="downloadCertificate()"
                  [disabled]="isDownloadingCertificate()">
                  @if (isDownloadingCertificate()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    <span>Baixando...</span>
                  } @else {
                    <mat-icon>workspace_premium</mat-icon>
                    <span>Emitir Certificado</span>
                  }
                </button>
              }
            </div>
          }
        </div>

        <mat-accordion class="modules-accordion">
          @for (module of modules(); track module.id) {
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <strong>Módulo {{ module.order }}: {{ module.title }}</strong>
                </mat-panel-title>
                <mat-panel-description>
                  {{ module.lessons?.length || 0 }} aulas
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="lessons-list">
                @for (lesson of module.lessons; track lesson.id) {
                  <button
                    type="button"
                    class="lesson-item"
                    [class.active]="currentLesson()?.id === lesson.id"
                    [class.locked]="!canAccessLesson(lesson)"
                    [class.completed]="completedLessons().has(lesson.id)"
                    [disabled]="!canAccessLesson(lesson)"
                    (click)="selectLesson(lesson)"
                    [attr.aria-label]="'Aula ' + lesson.order + ': ' + lesson.title + (completedLessons().has(lesson.id) ? ' - Concluída' : '')">

                    @if (isEnrolled()) {
                      <mat-checkbox
                        [checked]="completedLessons().has(lesson.id)"
                        [disabled]="!canAccessLesson(lesson)"
                        (change)="toggleLessonComplete(lesson, $event)"
                        (click)="$event.stopPropagation()"
                        (keydown)="$event.stopPropagation()"
                        [attr.aria-label]="'Marcar aula ' + lesson.title + ' como concluída'">
                      </mat-checkbox>
                    }

                    <div class="lesson-info">
                      <span class="lesson-name">
                        {{ lesson.order }}. {{ lesson.title }}
                      </span>
                      @if (lesson.videoUrl) {
                        <mat-icon class="video-icon" aria-hidden="true">play_circle_outline</mat-icon>
                      }
                    </div>

                    @if (!canAccessLesson(lesson)) {
                      <mat-icon class="lock-icon" aria-hidden="true">lock</mat-icon>
                    }
                  </button>
                }
              </div>

            </mat-expansion-panel>
          }
        </mat-accordion>

        @if (modules().length === 0) {
          <div class="empty-modules">
            <mat-icon>info</mat-icon>
            <p>Este curso ainda não possui módulos cadastrados.</p>
          </div>
        }

      </aside>

    </div>

  }

</div>
