<div class="forum-container">
  <header class="forum-header">
    <button
      type="button"
      class="btn-back"
      (click)="goBack()"
      aria-label="Voltar">
      <mat-icon>arrow_back</mat-icon>
      <span>Voltar</span>
    </button>

    <h1>Fórum de Dúvidas do Curso</h1>

    <div class="forum-actions">
      <button
        mat-raised-button
        color="primary"
        class="btn-new-question"
        (click)="toggleNewTopicForm()">
        <mat-icon>add_circle</mat-icon>
        Fazer uma Pergunta
      </button>

      <mat-form-field appearance="outline" class="filter-select">
        <mat-label>Filtrar por</mat-label>
        <mat-select
          [value]="filterType()"
          (selectionChange)="onFilterChange($event)">
          <mat-option value="recent">Mais Recentes</mat-option>
          <mat-option value="unanswered">Sem Resposta</mat-option>
          <mat-option value="popular">Mais Populares</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </header>

  <!-- Formulário de Novo Tópico -->
  @if (showNewTopicForm()) {
    <mat-card class="new-topic-form">
      <mat-card-header>
        <mat-card-title>Nova Pergunta</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="newTopicForm" (ngSubmit)="createTopic()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Título</mat-label>
            <input matInput formControlName="title" placeholder="Digite o título da sua dúvida">
            <mat-error *ngIf="newTopicForm.get('title')?.hasError('required')">
              Título é obrigatório
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descrição</mat-label>
            <textarea
              matInput
              formControlName="content"
              rows="5"
              placeholder="Descreva sua dúvida em detalhes">
            </textarea>
            <mat-error *ngIf="newTopicForm.get('content')?.hasError('required')">
              Descrição é obrigatória
            </mat-error>
          </mat-form-field>

          <div class="form-actions">
            <button mat-button type="button" (click)="toggleNewTopicForm()">
              Cancelar
            </button>
            <button mat-raised-button color="primary" type="submit">
              Publicar Pergunta
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Carregando tópicos...</p>
    </div>
  }

  <!-- Lista de Tópicos -->
  @if (!isLoading()) {
    <main class="question-list">
      @if (filteredTopics().length === 0) {
        <div class="empty-state">
          <mat-icon>forum</mat-icon>
          <h3>Nenhum tópico encontrado</h3>
          <p>Seja o primeiro a fazer uma pergunta!</p>
        </div>
      } @else {
        @for (topic of filteredTopics(); track topic.id) {
          <article class="question-item" (click)="goToTopic(topic.id)">
            <div class="status-indicator"
                 [class.status-resolved]="getResponseCount(topic) > 0"
                 [class.status-unanswered]="getResponseCount(topic) === 0">
            </div>

            <div class="question-content">
              <h3 class="question-title">{{ topic.title }}</h3>
              <p class="question-metadata">
                Postado por: <strong>{{ topic.user.name }}</strong> |
                {{ formatDate(topic.creationDate) }} |
                {{ topic.courseTitle }}
              </p>
            </div>

            <div class="question-stats">
              <span class="stat-count">{{ getResponseCount(topic) }}</span>
              <span class="stat-label">Respostas</span>
            </div>

            <div class="question-stats last-activity">
              <span class="stat-count">{{ getLastActivityDate(topic) }}</span>
              <span class="stat-label">Última Atividade</span>
            </div>
          </article>
        }
      }
    </main>
  }
</div>
